import cv2
import glob
import csv
from PIL import Image
from tqdm import tqdm

def process_image_pair(path1, path2):
    img1 = cv2.imread(path1)
    img2 = cv2.imread(path2)
    img11 = Image.open(path1).convert('RGB')
    img22 = Image.open(path2).convert('RGB')

    orb = cv2.ORB_create()
    queryKeypoints, queryDescriptors = orb.detectAndCompute(img1, None)
    trainKeypoints, trainDescriptors = orb.detectAndCompute(img2, None)

    matcher = cv2.BFMatcher()
    matches = matcher.match(queryDescriptors, trainDescriptors)
    matches = sorted(matches, key=lambda x: x.distance)

    results = []
    if len(matches) >= 10:
        for i in range(10):
            m = matches[i]
            qkp = queryKeypoints[m.queryIdx]
            tkp = trainKeypoints[m.trainIdx]
            results.append((
                m.distance,
                qkp.pt,
                tkp.pt,
                img11.getpixel(qkp.pt),
                img22.getpixel(tkp.pt),
                f'p_{path1.split("/")[-1]}',
                f'p_{path2.split("/")[-1]}'
            ))
    return results

def main():
    jpg_files = sorted(glob.glob("D:/dataset/train/p/*.jpg"))
    print(f"Total images: {len(jpg_files)}")

    with open("Targetpath:/feature_orb.csv", "w", newline='', encoding='utf-8') as csvfile:
        csv_writer = csv.writer(csvfile)
        csv_writer.writerow(['distance', 'pic_1', 'pic_2', 'point_1', 'point_2', 'filename_1', 'filename_2'])

        for i in tqdm(range(len(jpg_files) - 1), desc="Processing image pairs"):
            path1, path2 = jpg_files[i], jpg_files[i+1]
            results = process_image_pair(path1, path2)
            csv_writer.writerows(results)

if __name__ == "__main__":
    main()