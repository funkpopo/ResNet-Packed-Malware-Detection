# ResNet-Packed-Malware-Detection ![](https://img.shields.io/badge/license-Apache2.0-green)
Use image recognition methods to analyze packed malware.（使用图像识别方法对加壳恶意软件进行分类）

Based on ResNet, SIFT and ORB.（使用了ResNet，SIFT与ORB）

## 论文地址:https://ieeexplore.ieee.org/document/9637103

本项目当前在当前已经实现加固判断二分类且结果具有较高可靠性的基础上已经提供了便利地创建加固类型判断多分类的条件，确定程序加固的关键目标点，着眼于常见免杀机制规避检测手段的重点/隐匿作用点，通过摆脱一般的检测恶意代码作用区段，检测“非恶意”代码段/混淆段来对数种加固规避机制进行测试，在一定程度上降低研究人员在面对加固样本的分析难度，提供一个能快速定位软件加固的目标位置并具有较高可靠度的检测方法。

### 本项目未做完全的集成化，后续视情况更新

（***权重文件过大，不上传Git仓库，请移步“百度网盘”/“阿里云盘”分享链接目的地***）

***百度网盘 Baidu Netdisk***: 链接：https://pan.baidu.com/s/1yOeX_plfGBhwxPdPmgo1zA 

***提取码：`8613`***

***阿里云盘 aDrive***: 链接：https://www.aliyundrive.com/s/iEpejYqyW5P

**阿里云盘包含三个后续效果较好的权重文件，请务必在读取前更改“checkpoint”文件内的相关字段，否则无法正常读取**

项目所使用的Malware样本经过清理，采集来源于https://virusshare.com

样本集合标签为### 00375/ ### 00387

## 请务必不要在未经样本来源方允许的前提下擅自分享或传播Malware样本！！

****
* 使用的加壳工具：`VMProtect`/ `The Mida v3`
* 其他工具：`Ghidra`/ `IDA Pro`/ `Winhex`
* 硬件环境：

`Intel i7-9750H @2.60GHz 6 Core`

`Nvidia Geforce 1660Ti 6G（Tensor computeCapability：7.5）`

`Memory: 16.0GB 2666MHz`

`Windows 10 Dev preview （Build 23159.co_release.210409-1536）`

* 软件环境：

`PyCharm 2021.1 ( Community Edition)`

`Python 3.9.1 ( For sample analysis 样本预处理)`

`Python 3.8.8 ( For Tensorflow 模型搭建与测试)`

`Tensorflow 2.4.1 (GPU)`

`CUDA 11.3.0_456.89`

`cudnn 11.2v8.1.1.33`
****

### 项目结构
<details>
<summary>项目结构</summary>

```
.
├── .git
│   ├── branches
│   ├── config
│   ├── description
│   ├── HEAD
│   ├── hooks
│   │   ├── applypatch-msg.sample
│   │   ├── commit-msg.sample
│   │   ├── fsmonitor-watchman.sample
│   │   ├── post-update.sample
│   │   ├── pre-applypatch.sample
│   │   ├── pre-commit.sample
│   │   ├── pre-merge-commit.sample
│   │   ├── prepare-commit-msg.sample
│   │   ├── pre-push.sample
│   │   ├── pre-rebase.sample
│   │   ├── pre-receive.sample
│   │   ├── push-to-checkout.sample
│   │   └── update.sample
│   ├── index
│   ├── info
│   │   └── exclude
│   ├── logs
│   │   ├── HEAD
│   │   └── refs
│   │       ├── heads
│   │       │   └── main
│   │       └── remotes
│   │           └── origin
│   │               └── HEAD
│   ├── objects
│   │   ├── info
│   │   └── pack
│   │       ├── pack-6409bc34d1428f1b89d5949bba51fc194593852e.idx
│   │       └── pack-6409bc34d1428f1b89d5949bba51fc194593852e.pack
│   ├── packed-refs
│   └── refs
│       ├── heads
│       │   └── main
│       ├── remotes
│       │   └── origin
│       │       └── HEAD
│       └── tags
├── images
│   ├── No_pretrain_acc.png
│   ├── No_pretrain_loss.png
│   ├── Packed-sample.jpg
│   └── Unpacked-sample.jpg
├── LICENSE
├── README.md
├── ResNet
│   ├── class_indices.json
│   ├── model.py
│   ├── predict.py
│   ├── RGB_MEAN.py
│   └── train.py
└── Sample\ Preparation
    ├── Convert_file2image.py
    ├── cutimage_bat.py
    ├── delete_same_image.py
    ├── gray2rgb.py
    ├── ORB.py
    └── SIFT.py
```
</details>

#### 预处理步骤为（未作集成化处理）：
**Convert_file2image.py -> gray2rgb.py -> cutimage_bat.py -> delete_same_image.py**
<details>
<summary>预处理目录</summary>

```
.
└── Sample\ Preparation
    ├── Convert_file2image.py
    ├── cutimage_bat.py
    ├── delete_same_image.py
    ├── gray2rgb.py
    ├── ORB.py
    └── SIFT.py
```
</details>

****
### 编译注意事项
* 在对"train.py"与"model.py"文件进行编辑时，已经在使用者可能需要根据情况进行更改的区域进行了中文标注，当运行出现以下错误时，请根据下列说明进行修正。
  * 提示显存溢出/ 内存分配空间不足(OOM)：
      * 确认分类器的`label`数量是否对应`tf.keras.Sequential`中的`Dense`数值；
      * 确认`batch_size`大小是否处于当前主机的显卡压力范围内，如样本集大小超出显存负荷，尝试缩小图像，并换用CPU进行运算；
    
  * 提示无法找到`dataset`：
      * 确认目标路径中已经包含数据集（默认为"dataset"）并检查文件夹名是否对应；
  
  * 提示类型错误无法正常计算：
      * 检查需要输入数值的部分是否仍保留引号，尤其在是报错提示为"str cannot be..."的情况下；
    
  * 提示载入`resnet34/ resnet50/ resnet101`时的错误：
      * 检查头部引用时是否正确引用，并适当减小`model.py`文件内的`def`定义模型参数数值；


### 本项目中可以在训练完第一轮并在指定路径生成权重文件后随时终止（一般情况下第一轮所得权重参考价值较低），并将权重文件进行迁移学习使用。
    
****
### 结果

![image](https://github.com/funkpopo/ResNet-Packed-Malware-Detection/blob/main/images/Packed-sample.jpg)
![image](https://github.com/funkpopo/ResNet-Packed-Malware-Detection/blob/main/images/Unpacked-sample.jpg)
